var $dataGrid, $date1, $date2, $time;

var totalCnt = 0;
$(function() {
    Main.initVariable();
    Main.observe();
    Main.initDesign();
    Main.initData();
});

var Main = {
    /** variable */
    initVariable: function() {
        $dataGrid = $('#dataGrid'),
      //  $cbPeriod = $('#cbPeriod'),
        $time = $('#time'), $date1 = $('#date1'), $date2 = $('#date2');

    },

    /** add event */
    observe: function() {
        $('button').bind('click', function(event) {
            Main.eventControl(event);
        });
    },

    /** event handler */
    eventControl: function(event) {
        var curTarget = event.currentTarget;
        switch(curTarget.id) {
            case "btnSearch": this.search(); break;
            case "btnExport": this.exportRpt(); break;
        }
    },

    /** init design */
    initDesign: function() {
        // $('#mainSplitter').jqxSplitter({ width: '99.8%', height: '10.8%', orientation: 'horizon', theme: jqxTheme, panels: [{ size: 250, collapsible: false }, { size: '100%' }] });
        //Master.createPeriodCondition($cbPeriod,$date1,$date2);

        //구분
        var attack_type_cd = new Array();
        $.ajax({
            type: 'GET',
            url: ctxPath + '/api/code/getCommonCode',
            data: {comCode1: '4011' , codeLvl: '2'},
            async: false,
            success: function (data) {
                attack_type_cd.push({label: '전체', value: ''});
                $.each(data.resultData, function (index, data) {
                    attack_type_cd.push({label: data.codeName, value: data.comCode2})
                });
            }
        });
        $('#attack_type_cd').jqxDropDownList({source: attack_type_cd, width: 140, height:20 ,autoDropDownHeight: true, selectedIndex : 0 })

        var toDate = new Date();
        var fromDate = new Date();

        //타임인풋생성
        $date1.jqxDateTimeInput({width: '100px', height: '21px', formatString: "yyyy-MM-dd", theme: jqxTheme, culture: 'ko-KR'});
        $date2.jqxDateTimeInput({ width: '100px', height: '21px', formatString: "yyyy-MM-dd", theme: jqxTheme, culture: 'ko-KR'});

        // 올해 1월1일
        toDate.setFullYear(toDate.getFullYear(),0,1);

        //날짜 셋팅
        $date1.jqxDateTimeInput('setDate', toDate);
        $date2.jqxDateTimeInput('setDate', fromDate);

        //시간 생성
        $time.jqxDropDownList({ width: 50, height: 21, theme: jqxTheme, autoDropDownHeight: true,
            displayMember: 'label', valueMember: 'value', selectedIndex:6,
            source: [
                { label: '00', value: 0 },
                { label: '01', value: 1 },
                { label: '02', value: 2 },
                { label: '03', value: 3 },
                { label: '04', value: 4 },
                { label: '05', value: 5 },
                { label: '06', value: 6 },
                { label: '07', value: 7 },
                { label: '08', value: 8 },
                { label: '09', value: 9 },
                { label: '10', value: 10 },
                { label: '11', value: 11 },
                { label: '12', value: 12 },
                { label: '13', value: 13 },
                { label: '14', value: 14 },
                { label: '15', value: 15 },
                { label: '16', value: 16 },
                { label: '17', value: 17 },
                { label: '18', value: 18 },
                { label: '19', value: 19 },
                { label: '20', value: 20 },
                { label: '21', value: 21 },
                { label: '22', value: 22 },
                { label: '23', value: 23 }
            ]
        });

        HmGrid.create($dataGrid, {
            source: new $.jqx.dataAdapter(
                {
                    datatype: 'json',
                    url: $('#ctxPath').val() + '/api/main/rpt/reportCollection/getRetrieveSecurityVulnerabilityDetail',
                    beforeprocessing: function(data) {
                        if(data != null){
                            totalCnt = data.resultData.length;
                        }
                    }
                },
                {
                    formatData: function(data) {
                        $.extend(data, Main.getCommParams());
                        return data;
                    }
                }
            ),
         /*   height: '100%',*/
         autorowheight: true,
            pageable : true,
            pagermode: 'default',
            showtoolbar: false,
          /*  rendertoolbar: function(toolbar) {
                HmGrid.titlerenderer(toolbar, '취약점관리대장');
            },*/
            columns:
                [
                    { text: '순번', datafield: 'seqNo',cellsalign : 'center', width: '3%',
                        cellsrenderer: function(row, column, value, rowData) {
                            return "<div style='margin-top: 4px; margin-right: 5px' class='jqx-center-align'>" + (totalCnt - row)*1 +"</div>";
                    }},
                    { text: '사고번호', datafield: 'inciNo', cellsalign : 'center', width: '7%' },
                    { text: '취약점내용', datafield: 'inciTtl',cellsalign : 'left', width: '14%'},
                    { text: '피해기관명', datafield: 'instNm', cellsalign : 'center', width: '3%'},
                    { text: '접수일자', datafield: 'inciAcpnDt', cellsalign : 'center', width: '3%'},
                    { text: '조치사항', datafield: 'vulnerbilityCont',cellsalign : 'left', width: '35%' },
                    { text: '시도결과', datafield: 'hstyCont', cellsalign : 'left', width: '35%' }
                ]
        });

    },

    /** init data */
    initData: function() {

    },

    search: function() {
        HmGrid.updateBoundData($dataGrid);
    },

    /** 공통 파라미터 */
    getCommParams: function() {
        //var startDt = HmDate.getDateStr($('#date1'));
        //var endDt = HmDate.getDateStr($('#date2'));

        var agoTime = ($time.val()-1)==-1?23:$time.val()-1;

        var params = {
            startDt : HmDate.getDateStr($('#date1'))+HmDate.addZero(agoTime)+'5959',
            endDt: HmDate.getDateStr($('#date2'))+HmDate.addZero($time.val())+'0000',
            attackTypeCd: $("#attack_type_cd").val(),
            instNm: $("#instNmText").val()
        }
        return params;
    },

    /** export */
    exportRpt: function() {
        var params = Main.getCommParams();
        HmUtil.exportExcel(ctxPath + '/api/main/rpt/reportCollection/exportRetrieveSecurityVulnerability', params);
    }

};
