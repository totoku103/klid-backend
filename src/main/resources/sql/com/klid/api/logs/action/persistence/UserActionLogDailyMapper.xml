<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.klid.api.logs.action.persistence.UserActionLogDailyMapper">

    <resultMap id="dailyResultMap" type="com.klid.api.logs.action.dto.UserActionLogDailyResDTO">
        <result property="timeSlot" column="TIME_SLOT"/>
        <result property="sumCount" column="SUM_COUNT"/>
    </resultMap>

    <!-- 일별 시간대별 행동 로그 조회 -->
    <select id="selectUserActionLogDailyData" resultMap="dailyResultMap">
        SELECT
            T.TIME_SLOT,
            NVL(D.CNT, 0) AS SUM_COUNT
        FROM (
            SELECT LPAD(LEVEL - 1, 2, '0') AS TIME_SLOT
            FROM DUAL
            CONNECT BY LEVEL &lt;= 24
        ) T
        LEFT JOIN (
            SELECT
                SUBSTR(REG_DATE, 9, 2) AS HOUR_SLOT,
                COUNT(*) AS CNT
            FROM USER_ACT_HIST
            WHERE REG_DATE LIKE #{yyyyMMdd} || '%'
            <if test="systemType != null and systemType != '' and systemType != 'ctrs'">
                AND 1 = 0
            </if>
            GROUP BY SUBSTR(REG_DATE, 9, 2)
        ) D ON T.TIME_SLOT = D.HOUR_SLOT
        ORDER BY T.TIME_SLOT
    </select>

</mapper>
